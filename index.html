<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Zorro | Gestión Integral</title>

    <!-- External Libs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #D4AF37;
            --primary-dark: #b59022;
            --dark: #1a1a1a;
            --light: #f4f4f4;
            --white: #ffffff;
            --gray: #666666;
            --border: #e0e0e0;
            --danger: #ff4757;
            --success: #2ed573;
            --warning: #ffa502;
            --sidebar-width: 260px;
            --header-height: 70px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--light);
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: var(--white);
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 40px;
            color: var(--primary);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: var(--radius);
            margin-bottom: 5px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(212, 175, 55, 0.15);
            color: var(--primary);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .header {
            height: var(--header-height);
            background: var(--white);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* --- COMPONENTS --- */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--dark);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--gray);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(46, 213, 115, 0.15);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 165, 2, 0.15);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(255, 71, 87, 0.15);
            color: var(--danger);
        }

        /* --- FORMS --- */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: var(--white);
            width: 90%;
            max-width: 600px;
            border-radius: var(--radius);
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* --- DASHBOARD GRID --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .kpi-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(212, 175, 55, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .kpi-info h3 {
            font-size: 1.8rem;
            margin-bottom: 2px;
        }

        .kpi-info p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* --- NOTIFICATIONS --- */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--dark);
            color: white;
            border-radius: 8px;
            transform: translateY(100px);
            transition: 0.3s;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.success {
            background: var(--success);
        }

        /* --- UTILS --- */
        .hidden {
            display: none !important;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
                transform: translateX(-100%);
                z-index: 999;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-bread-slice"></i> El Zorro <span
                style="font-weight:300; font-size:0.8rem; margin-left:5px; opacity:0.7;">Gestión</span>
        </div>
        <nav>
            <a class="nav-link active" data-view="dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a>
            <a class="nav-link" data-view="orders"><i class="fas fa-receipt"></i> Pedidos</a>
            <a class="nav-link" data-view="products"><i class="fas fa-cookie"></i> Productos</a>
            <a class="nav-link" data-view="inventory"><i class="fas fa-boxes"></i> Stock</a>
            <a class="nav-link" data-view="clients"><i class="fas fa-users"></i> Clientes</a>
            <a class="nav-link" data-view="config"><i class="fas fa-cog"></i> Configuración</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
        <header class="header">
            <button class="btn-outline" id="menu-toggle" style="border:none; font-size:1.2rem;"><i
                    class="fas fa-bars"></i></button>
            <h2 class="page-title" id="page-title">Dashboard</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <span class="badge badge-success" id="db-status">Online</span>
            </div>
        </header>

        <div class="content-area" id="app-container">
            <!-- VIEWS WILL BE INJECTED HERE -->
        </div>
    </main>

    <!-- GENERIC MODAL -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-box">
            <div class="flex-between" style="margin-bottom:20px;">
                <h3 id="modal-title">Título Modal</h3>
                <button class="btn-outline" onclick="UI.closeModal()"
                    style="border:none; font-size:1.2rem;">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i> <span id="toast-msg">Mensaje</span>
    </div>

    <script type="module">
        /* =========================================
           MODULE: UTILS
           ========================================= */
        const Utils = {
            formatCurrency: (num) => {
                return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(num);
            },
            formatDate: (isoString) => {
                if (!isoString) return '';
                return new Date(isoString).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            },
            generateId: () => {
                return '_' + Math.random().toString(36).substr(2, 9);
            },
            debounce: (func, wait) => {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            },
            convertUnit: (value, fromUnit, toUnit) => {
                if (fromUnit === toUnit) return value;

                const conversions = {
                    'kg': { 'g': 1000, 'mg': 1000000 },
                    'g': { 'kg': 0.001, 'mg': 1000 },
                    'L': { 'ml': 1000, 'cl': 100, 'dl': 10 },
                    'ml': { 'L': 0.001, 'cl': 0.1 },
                    'cl': { 'L': 0.01, 'ml': 10 }
                };

                if (conversions[fromUnit] && conversions[fromUnit][toUnit]) {
                    return value * conversions[fromUnit][toUnit];
                }

                // Inverse check
                if (conversions[toUnit] && conversions[toUnit][fromUnit]) {
                    return value / conversions[toUnit][fromUnit];
                }

                return value; // Fallback if no conversion found
            },
            getCompatibleUnits: (unit) => {
                const groups = [
                    ['kg', 'g', 'mg'],
                    ['L', 'ml', 'cl', 'dl'],
                    ['ud']
                ];
                const group = groups.find(g => g.includes(unit));
                return group || [unit];
            }
        };

        /* =========================================
           MODULE: DATABASE (IndexedDB)
           ========================================= */
        const DB_NAME = 'ElZorroGestionDB';
        const DB_VERSION = 2;

        class DBModule {
            constructor() {
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = (e) => {
                        console.error("DB Error", e);
                        UI.showToast("Error al abrir base de datos", "error");
                        reject(e);
                    };

                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        console.log("DB Opened Successfully");
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        // Stores
                        if (!db.objectStoreNames.contains('clients')) {
                            const store = db.createObjectStore('clients', { keyPath: 'id' });
                            store.createIndex('name', 'name', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('products')) {
                            const store = db.createObjectStore('products', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('orders')) {
                            const store = db.createObjectStore('orders', { keyPath: 'id' });
                            store.createIndex('status', 'status', { unique: false });
                            store.createIndex('date', 'date', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('inventory')) {
                            const store = db.createObjectStore('inventory', { keyPath: 'id' });
                            store.createIndex('type', 'type', { unique: false });
                        }
                    };
                });
            }

            // Generic CRUD
            async getAll(storeName) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result);
                });
            }

            async add(storeName, item) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    store.put(item);
                    tx.oncomplete = () => resolve(item);
                });
            }

            async delete(storeName, id) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    store.delete(id);
                    tx.oncomplete = () => resolve();
                });
            }

            async clearAll() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(['clients', 'products', 'orders'], 'readwrite');
                    tx.objectStore('clients').clear();
                    tx.objectStore('products').clear();
                    tx.objectStore('orders').clear();
                    tx.oncomplete = () => resolve();
                });
            }

            async seedDefaults() {
                const count = await new Promise(resolve => {
                    const req = this.db.transaction('products').objectStore('products').count();
                    req.onsuccess = () => resolve(req.result);
                });

                if (count === 0) {
                    console.log("Seeding default products...");
                    const defaults = [
                        { id: '2', name: "Tiramisú Artesano", price: 0, prepTime: 60, costs: [], totalCost: 0, updated: new Date().toISOString() },
                        { id: '3', name: "Mantecados de canela y ajonjolí", price: 0.95, prepTime: 45, costs: [], totalCost: 0, updated: new Date().toISOString() },
                        { id: '4', name: "Galletas de jengibre", price: 0.50, prepTime: 30, costs: [], totalCost: 0, updated: new Date().toISOString() },
                        { id: '5', name: "Palmeras de hojaldre", price: 0.60, prepTime: 40, costs: [], totalCost: 0, updated: new Date().toISOString() },
                        { id: '8', name: "Magdalenas Caseras", price: 0.50, prepTime: 35, costs: [], totalCost: 0, updated: new Date().toISOString() }, // Estimated price
                        { id: '9', name: "Galletas con chips de chocolate", price: 1.20, prepTime: 25, costs: [], totalCost: 0, updated: new Date().toISOString() }
                    ];

                    const tx = this.db.transaction('products', 'readwrite');
                    const store = tx.objectStore('products');
                    defaults.forEach(p => store.add(p));
                    return new Promise(resolve => tx.oncomplete = resolve);
                }
            }
        }

        const DB = new DBModule();

        /* =========================================
           MODULE: UI HELPER
           ========================================= */
        const UI = {
            showToast: (msg, type = 'info') => {
                const t = document.getElementById('toast');
                const m = document.getElementById('toast-msg');
                m.innerText = msg;
                t.className = `toast show ${type}`;
                setTimeout(() => t.classList.remove('show'), 3000);
            },
            render: (html) => {
                document.getElementById('app-container').innerHTML = html;
            },
            openModal: (title, html) => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = html;
                document.getElementById('modal-overlay').classList.add('active');
            },
            closeModal: () => {
                document.getElementById('modal-overlay').classList.remove('active');
            }
        };

        // Expose UI to window for inline onclicks
        window.UI = UI;

        /* =========================================
           PLACEHOLDERS FOR LOGIC MODULES
           ========================================= */

        /* =========================================
           MODULE: CLIENTS
           ========================================= */
        const ClientsModule = {
            render: async () => {
                document.getElementById('page-title').innerText = 'Gestión de Clientes';
                const clients = await DB.getAll('clients');

                let html = `
                    <div class="card">
                        <div class="flex-between" style="margin-bottom:20px;">
                            <input type="text" id="client-search" class="form-control" style="max-width:300px;" placeholder="Buscar cliente...">
                            <button class="btn btn-primary" onclick="ClientsModule.openForm()"><i class="fas fa-plus"></i> Nuevo Cliente</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Teléfono</th>
                                        <th>Dirección</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="clients-table-body">
                                    ${ClientsModule.renderRows(clients)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                UI.render(html);

                // Search Event
                document.getElementById('client-search').addEventListener('keyup', Utils.debounce((e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = clients.filter(c => c.name.toLowerCase().includes(term) || c.phone.includes(term));
                    document.getElementById('clients-table-body').innerHTML = ClientsModule.renderRows(filtered);
                }, 300));
            },

            renderRows: (clients) => {
                if (clients.length === 0) return '<tr><td colspan="4" style="text-align:center; color:var(--gray);">No hay clientes registrados</td></tr>';
                return clients.map(c => `
                    <tr>
                        <td><strong>${c.name}</strong></td>
                        <td>${c.phone}</td>
                        <td>${c.address}</td>
                        <td>
                            <button class="btn-outline" onclick="ClientsModule.openForm('${c.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-outline" style="color:var(--danger); border-color:var(--danger);" onclick="ClientsModule.delete('${c.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            openForm: async (id = null) => {
                let client = { name: '', phone: '', address: '' };
                if (id) {
                    const clients = await DB.getAll('clients');
                    client = clients.find(c => c.id === id);
                }

                const formHtml = `
                    <form onsubmit="event.preventDefault(); ClientsModule.save('${id || ''}')">
                        <div class="form-group">
                            <label class="form-label">Nombre Completo *</label>
                            <input type="text" id="c-name" class="form-control" value="${client.name}" required>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Teléfono *</label>
                                <input type="tel" id="c-phone" class="form-control" value="${client.phone}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dirección</label>
                                <input type="text" id="c-address" class="form-control" value="${client.address}">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px;">Guardar Cliente</button>
                    </form>
                `;
                UI.openModal(id ? 'Editar Cliente' : 'Nuevo Cliente', formHtml);
            },

            save: async (id) => {
                const client = {
                    id: id || Utils.generateId(),
                    name: document.getElementById('c-name').value,
                    phone: document.getElementById('c-phone').value,
                    address: document.getElementById('c-address').value,
                    created: new Date().toISOString()
                };

                await DB.add('clients', client);
                UI.closeModal();
                UI.showToast('Cliente guardado correctamente', 'success');
                ClientsModule.render();
            },

            delete: async (id) => {
                if (confirm('¿Estás seguro de eliminar este cliente?')) {
                    await DB.delete('clients', id);
                    UI.showToast('Cliente eliminado', 'success');
                    ClientsModule.render();
                }
            }
        };
        window.ClientsModule = ClientsModule;

        /* =========================================
           MODULE: PRODUCTS
           ========================================= */
        const ProductsModule = {
            render: async () => {
                document.getElementById('page-title').innerText = 'Gestión de Productos';
                const products = await DB.getAll('products');

                let html = `
                    <div class="card">
                        <div class="flex-between" style="margin-bottom:20px;">
                            <input type="text" id="prod-search" class="form-control" style="max-width:300px;" placeholder="Buscar producto...">
                            <button class="btn btn-primary" onclick="ProductsModule.openForm()"><i class="fas fa-plus"></i> Nuevo Producto</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Precio Venta</th>
                                        <th>Coste Total</th>
                                        <th>Margen</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="prod-table-body">
                                    ${ProductsModule.renderRows(products)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                UI.render(html);

                document.getElementById('prod-search').addEventListener('keyup', Utils.debounce((e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = products.filter(p => p.name.toLowerCase().includes(term));
                    document.getElementById('prod-table-body').innerHTML = ProductsModule.renderRows(filtered);
                }, 300));
            },

            renderRows: (products) => {
                if (products.length === 0) return '<tr><td colspan="5" style="text-align:center; color:var(--gray);">No hay productos registrados</td></tr>';
                return products.map(p => {
                    const margin = p.price - p.totalCost;
                    const marginPercent = p.price > 0 ? ((margin / p.price) * 100).toFixed(1) : 0;
                    const badgeClass = marginPercent > 30 ? 'badge-success' : (marginPercent > 15 ? 'badge-warning' : 'badge-danger');

                    return `
                    <tr>
                        <td><strong>${p.name}</strong><br><small style="color:var(--gray);">${p.prepTime} min prep</small></td>
                        <td>${Utils.formatCurrency(p.price)}</td>
                        <td>${Utils.formatCurrency(p.totalCost)}</td>
                        <td><span class="badge ${badgeClass}">${marginPercent}% (${Utils.formatCurrency(margin)})</span></td>
                        <td>
                            <button class="btn-outline" onclick="ProductsModule.openForm('${p.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-outline" style="color:var(--danger); border-color:var(--danger);" onclick="ProductsModule.delete('${p.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `}).join('');
            },

            openForm: async (id = null) => {
                let prod = { name: '', price: 0, prepTime: 0, costs: [] };
                if (id) {
                    const products = await DB.getAll('products');
                    prod = products.find(p => p.id === id);
                }

                const formHtml = `
                    <form onsubmit="event.preventDefault(); ProductsModule.save('${id || ''}')">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Nombre Producto *</label>
                                <input type="text" id="p-name" class="form-control" value="${prod.name}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tiempo Prep. (min)</label>
                                <input type="number" id="p-time" class="form-control" value="${prod.prepTime}">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Precio Venta (€) *</label>
                                <input type="number" step="0.01" id="p-price" class="form-control" value="${prod.price}" required onchange="ProductsModule.calcTotals()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Coste Total (€)</label>
                                <input type="text" id="p-total-cost" class="form-control" value="${prod.totalCost || 0}" readonly style="background:#eee;">
                            </div>
                        </div>

                        <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                            <div class="flex-between" style="margin-bottom:10px;">
                                <label class="form-label">Costes Variables (Ingredientes, etc.)</label>
                                <div>
                                    <button type="button" class="btn btn-outline" style="font-size:0.8rem; padding:5px 10px;" onclick="ProductsModule.addInventoryCost()"><i class="fas fa-carrot"></i> Desde Stock</button>
                                    <button type="button" class="btn btn-outline" style="font-size:0.8rem; padding:5px 10px;" onclick="ProductsModule.addCostRow()">+ Manual</button>
                                </div>
                            </div>
                            <div id="cost-rows">
                                ${prod.costs.map(c => ProductsModule.getCostRowHtml(c.name, c.amount)).join('')}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width:100%; margin-top:20px;">Guardar Producto</button>
                    </form>
                `;
                UI.openModal(id ? 'Editar Producto' : 'Nuevo Producto', formHtml);
                if (prod.costs.length === 0) ProductsModule.addCostRow(); // Add one empty row by default
            },

            getCostRowHtml: (name = '', amount = '', isInventory = false, invId = '') => `
                <div class="grid-2 cost-row" style="margin-bottom:10px;">
                    ${isInventory ?
                    `<input type="text" class="form-control cost-name" value="${name}" readonly style="background:#eee;" data-inv-id="${invId}">` :
                    `<input type="text" placeholder="Concepto (ej. Harina)" class="form-control cost-name" value="${name}" required>`
                }
                    <div style="display:flex; gap:5px;">
                        <input type="number" step="0.01" placeholder="€" class="form-control cost-amount" value="${amount}" required onchange="ProductsModule.calcTotals()">
                        <button type="button" class="btn-outline" style="color:var(--danger);" onclick="this.parentElement.parentElement.remove(); ProductsModule.calcTotals();">&times;</button>
                    </div>
                </div>
            `,

            addCostRow: () => {
                document.getElementById('cost-rows').insertAdjacentHTML('beforeend', ProductsModule.getCostRowHtml());
            },

            addInventoryCost: async () => {
                const items = await DB.getAll('inventory');
                const ingredients = items.filter(i => i.type === 'ingredient');

                if (ingredients.length === 0) {
                    UI.showToast('No hay ingredientes en Stock', 'warning');
                    return;
                }

                // Create a small modal or prompt to select ingredient
                // For simplicity, let's use a prompt-like overlay or just inject a selector row
                // Better UX: Inject a row with a select first

                const selectHtml = `
                    <div class="grid-2 cost-row-select" style="margin-bottom:10px; background:#f0f0f0; padding:10px; border-radius:8px;">
                        <select class="form-control inv-select" onchange="ProductsModule.onInvSelect(this)">
                            <option value="">-- Seleccionar Ingrediente --</option>
                            ${ingredients.map(i => `<option value="${i.id}" data-cost="${i.cost}" data-unit="${i.unit}" data-name="${i.name}">${i.name} (${Utils.formatCurrency(i.cost)}/${i.unit})</option>`).join('')}
                        </select>
                        <button type="button" class="btn-outline" onclick="this.parentElement.remove()">&times;</button>
                    </div>
                `;
                document.getElementById('cost-rows').insertAdjacentHTML('beforeend', selectHtml);
            },

            onInvSelect: (select) => {
                const option = select.options[select.selectedIndex];
                if (!option.value) return;

                const id = option.value;
                const costPerUnit = parseFloat(option.getAttribute('data-cost'));
                const stockUnit = option.getAttribute('data-unit');
                const name = option.getAttribute('data-name');
                const compatibleUnits = Utils.getCompatibleUnits(stockUnit);

                // Create a small inline form to ask for quantity and unit
                const inputHtml = `
                    <div class="grid-2 cost-row-input" style="margin-bottom:10px; background:#f0f0f0; padding:10px; border-radius:8px; align-items:end;">
                        <div class="form-group">
                            <label style="font-size:0.8rem;">Cantidad</label>
                            <input type="number" step="0.001" class="form-control qty-input" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label style="font-size:0.8rem;">Unidad</label>
                            <select class="form-control unit-select">
                                ${compatibleUnits.map(u => `<option value="${u}" ${u === stockUnit ? 'selected' : ''}>${u}</option>`).join('')}
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="ProductsModule.confirmInvAdd(this, '${id}', '${name}', ${costPerUnit}, '${stockUnit}')">Añadir</button>
                        <button type="button" class="btn-outline" onclick="this.parentElement.remove()">Cancelar</button>
                    </div>
                `;

                select.parentElement.insertAdjacentHTML('afterend', inputHtml);
                select.parentElement.remove();
            },

            confirmInvAdd: (btn, id, name, costPerStockUnit, stockUnit) => {
                const container = btn.parentElement;
                const qty = parseFloat(container.querySelector('.qty-input').value);
                const consumptionUnit = container.querySelector('.unit-select').value;

                if (!qty || isNaN(qty)) {
                    UI.showToast('Introduce una cantidad válida', 'warning');
                    return;
                }

                // Convert consumption quantity to stock unit to calculate cost
                // Example: Stock in kg, consumed 200 g.
                // Need to convert 200 g to kg -> 0.2 kg.
                // Cost = 0.2 * costPerKg

                // We need to convert FROM consumptionUnit TO stockUnit
                // But Utils.convertUnit(value, from, to) converts value.
                // So convertUnit(200, 'g', 'kg') -> 0.2

                const qtyInStockUnit = Utils.convertUnit(qty, consumptionUnit, stockUnit);
                const finalCost = (costPerStockUnit * qtyInStockUnit).toFixed(4); // More precision for small amounts

                const displayName = `${name} (${qty} ${consumptionUnit})`;

                // Add the row
                const rowHtml = ProductsModule.getCostRowHtml(displayName, parseFloat(finalCost).toFixed(2), true, id);
                container.insertAdjacentHTML('afterend', rowHtml);
                container.remove();
                ProductsModule.calcTotals();
            },
            calcTotals: () => {
                const rows = document.querySelectorAll('.cost-row');
                let total = 0;
                rows.forEach(row => {
                    const val = parseFloat(row.querySelector('.cost-amount').value) || 0;
                    total += val;
                });
                document.getElementById('p-total-cost').value = total.toFixed(2);
            },

            save: async (id) => {
                const costs = [];
                let totalCost = 0;
                document.querySelectorAll('.cost-row').forEach(row => {
                    const name = row.querySelector('.cost-name').value;
                    const amount = parseFloat(row.querySelector('.cost-amount').value) || 0;
                    if (name) {
                        costs.push({ name, amount });
                        totalCost += amount;
                    }
                });

                const prod = {
                    id: id || Utils.generateId(),
                    name: document.getElementById('p-name').value,
                    prepTime: parseInt(document.getElementById('p-time').value) || 0,
                    price: parseFloat(document.getElementById('p-price').value) || 0,
                    costs: costs,
                    totalCost: totalCost,
                    updated: new Date().toISOString()
                };

                await DB.add('products', prod);
                UI.closeModal();
                UI.showToast('Producto guardado', 'success');
                ProductsModule.render();
            },

            delete: async (id) => {
                if (confirm('¿Eliminar producto?')) {
                    await DB.delete('products', id);
                    UI.showToast('Producto eliminado', 'success');
                    ProductsModule.render();
                }
            }
        };
        window.ProductsModule = ProductsModule;

        /* =========================================
           MODULE: ORDERS
           ========================================= */
        const OrdersModule = {
            render: async () => {
                document.getElementById('page-title').innerText = 'Gestión de Pedidos';
                const orders = await DB.getAll('orders');
                const clients = await DB.getAll('clients');

                // Sort by date desc
                orders.sort((a, b) => new Date(b.date) - new Date(a.date));

                let html = `
                    <div class="card">
                        <div class="flex-between" style="margin-bottom:20px;">
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-outline active" onclick="OrdersModule.filter('all')">Todos</button>
                                <button class="btn btn-outline" onclick="OrdersModule.filter('Pendiente')">Pendientes</button>
                                <button class="btn btn-outline" onclick="OrdersModule.filter('Listo')">Listos</button>
                            </div>
                            <button class="btn btn-primary" onclick="OrdersModule.openForm()"><i class="fas fa-plus"></i> Nuevo Pedido</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID / Fecha</th>
                                        <th>Cliente</th>
                                        <th>Estado</th>
                                        <th>Pago</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body">
                                    ${OrdersModule.renderRows(orders, clients)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                UI.render(html);
            },

            renderRows: (orders, clients) => {
                if (orders.length === 0) return '<tr><td colspan="6" style="text-align:center; color:var(--gray);">No hay pedidos registrados</td></tr>';
                return orders.map(o => {
                    const clientName = clients.find(c => c.id === o.clientId)?.name || 'Cliente Desconocido';
                    const statusColor = o.status === 'Entregado' ? 'success' : (o.status === 'Pendiente' ? 'warning' : 'primary');
                    const payColor = o.paymentStatus === 'Pagado' ? 'success' : (o.paymentStatus === 'Parcial' ? 'warning' : 'danger');

                    return `
                    <tr>
                        <td><small style="color:var(--gray);">#${o.id.substr(0, 5)}</small><br>${Utils.formatDate(o.date)}</td>
                        <td><strong>${clientName}</strong></td>
                        <td><span class="badge badge-${statusColor}">${o.status}</span></td>
                        <td><span class="badge badge-${payColor}">${o.paymentStatus}</span></td>
                        <td><strong>${Utils.formatCurrency(o.total)}</strong></td>
                        <td>
                            <button class="btn-outline" onclick="OrdersModule.openForm('${o.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-outline" style="color:var(--danger); border-color:var(--danger);" onclick="OrdersModule.delete('${o.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `}).join('');
            },

            filter: async (status) => {
                const orders = await DB.getAll('orders');
                const clients = await DB.getAll('clients');
                const filtered = status === 'all' ? orders : orders.filter(o => o.status === status);
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                document.getElementById('orders-table-body').innerHTML = OrdersModule.renderRows(filtered, clients);
            },

            openForm: async (id = null) => {
                const clients = await DB.getAll('clients');
                const products = await DB.getAll('products');

                let order = { clientId: '', status: 'Pendiente', paymentStatus: 'No Pagado', items: [], total: 0 };
                if (id) {
                    const orders = await DB.getAll('orders');
                    order = orders.find(o => o.id === id);
                }

                const formHtml = `
                    <form onsubmit="event.preventDefault(); OrdersModule.save('${id || ''}')">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Cliente *</label>
                                <select id="o-client" class="form-control" required>
                                    <option value="">Seleccionar Cliente...</option>
                                    ${clients.map(c => `<option value="${c.id}" ${c.id === order.clientId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <select id="o-status" class="form-control">
                                    <option ${order.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                    <option ${order.status === 'Preparando' ? 'selected' : ''}>Preparando</option>
                                    <option ${order.status === 'Listo' ? 'selected' : ''}>Listo</option>
                                    <option ${order.status === 'Entregado' ? 'selected' : ''}>Entregado</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="background:#f9f9f9; padding:15px; border-radius:8px;">
                            <label class="form-label">Productos</label>
                            <div id="order-items">
                                ${order.items.map(item => OrdersModule.getItemRowHtml(products, item.prodId, item.qty)).join('')}
                            </div>
                            <button type="button" class="btn btn-outline" style="margin-top:10px; width:100%;" onclick="OrdersModule.addItemRow()">+ Añadir Producto</button>
                        </div>

                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Estado Pago</label>
                                <select id="o-pay" class="form-control">
                                    <option ${order.paymentStatus === 'No Pagado' ? 'selected' : ''}>No Pagado</option>
                                    <option ${order.paymentStatus === 'Parcial' ? 'selected' : ''}>Parcial</option>
                                    <option ${order.paymentStatus === 'Pagado' ? 'selected' : ''}>Pagado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total (€)</label>
                                <input type="text" id="o-total" class="form-control" value="${order.total}" readonly style="font-weight:bold; font-size:1.2rem;">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width:100%;">Guardar Pedido</button>
                    </form>
                `;

                // Store products globally for the modal context to avoid re-fetching
                window._productsCache = products;

                UI.openModal(id ? 'Editar Pedido' : 'Nuevo Pedido', formHtml);
                if (order.items.length === 0) OrdersModule.addItemRow();
            },

            getItemRowHtml: (products, selectedId = '', qty = 1) => `
                <div class="grid-2 order-item-row" style="margin-bottom:10px; align-items:end;">
                    <div>
                        <select class="form-control item-select" onchange="OrdersModule.calcTotal()">
                            <option value="" data-price="0">Seleccionar...</option>
                            ${products.map(p => `<option value="${p.id}" data-price="${p.price}" ${p.id === selectedId ? 'selected' : ''}>${p.name} (${p.price}€)</option>`).join('')}
                        </select>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="number" class="form-control item-qty" value="${qty}" min="1" onchange="OrdersModule.calcTotal()">
                        <button type="button" class="btn-outline" style="color:var(--danger);" onclick="this.parentElement.parentElement.remove(); OrdersModule.calcTotal();">&times;</button>
                    </div>
                </div>
            `,

            addItemRow: () => {
                const products = window._productsCache || [];
                document.getElementById('order-items').insertAdjacentHTML('beforeend', OrdersModule.getItemRowHtml(products));
            },

            calcTotal: () => {
                let total = 0;
                document.querySelectorAll('.order-item-row').forEach(row => {
                    const select = row.querySelector('.item-select');
                    const price = parseFloat(select.options[select.selectedIndex]?.dataset.price) || 0;
                    const qty = parseInt(row.querySelector('.item-qty').value) || 1;
                    total += price * qty;
                });
                document.getElementById('o-total').value = total.toFixed(2);
            },

            save: async (id) => {
                const items = [];
                document.querySelectorAll('.order-item-row').forEach(row => {
                    const prodId = row.querySelector('.item-select').value;
                    const qty = parseInt(row.querySelector('.item-qty').value) || 1;
                    if (prodId) items.push({ prodId, qty });
                });

                if (items.length === 0) return UI.showToast('Añade al menos un producto', 'error');

                const order = {
                    id: id || Utils.generateId(),
                    clientId: document.getElementById('o-client').value,
                    status: document.getElementById('o-status').value,
                    paymentStatus: document.getElementById('o-pay').value,
                    items: items,
                    total: parseFloat(document.getElementById('o-total').value),
                    date: new Date().toISOString()
                };

                await DB.add('orders', order);
                UI.closeModal();
                UI.showToast('Pedido guardado', 'success');
                OrdersModule.render();
            },

            delete: async (id) => {
                if (confirm('¿Eliminar pedido?')) {
                    await DB.delete('orders', id);
                    UI.showToast('Pedido eliminado', 'success');
                    OrdersModule.render();
                }
            }
        };
        window.OrdersModule = OrdersModule;

        /* =========================================
           MODULE: DASHBOARD (ADVANCED)
           ========================================= */
        const DashboardModule = {
            render: async () => {
                document.getElementById('page-title').innerText = 'Dashboard & Analytics';

                // Initial Render Structure
                let html = `
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="flex-between">
                            <h3><i class="fas fa-filter"></i> Filtro de Periodo</h3>
                            <select id="dash-period" class="form-control" style="width:200px;" onchange="DashboardModule.loadData()">
                                <option value="7">Últimos 7 días</option>
                                <option value="30" selected>Últimos 30 días</option>
                                <option value="month">Este Mes</option>
                                <option value="all">Todo el Historial</option>
                            </select>
                        </div>
                    </div>

                    <div id="dash-content">
                        <!-- Content will be loaded here -->
                        <div style="text-align:center; padding:50px;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
                    </div>
                `;
                UI.render(html);
                DashboardModule.loadData();
            },

            loadData: async () => {
                const period = document.getElementById('dash-period').value;
                const orders = await DB.getAll('orders');
                const products = await DB.getAll('products');
                const inventory = await DB.getAll('inventory');
                const fixedCostsItems = inventory.filter(i => i.type === 'fixed');

                // Filter Orders by Date
                const now = new Date();
                let filteredOrders = orders;
                let startDate = new Date(0); // Epoch

                if (period === '7') {
                    startDate = new Date();
                    startDate.setDate(now.getDate() - 7);
                } else if (period === '30') {
                    startDate = new Date();
                    startDate.setDate(now.getDate() - 30);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }

                if (period !== 'all') {
                    filteredOrders = orders.filter(o => new Date(o.date) >= startDate);
                }

                // --- CALCULATIONS ---

                // 1. Revenue
                const totalRevenue = filteredOrders.reduce((acc, o) => acc + o.total, 0);

                // 2. Variable Costs (Ingredients)
                let totalVariableCost = 0;
                filteredOrders.forEach(o => {
                    o.items.forEach(item => {
                        const prod = products.find(p => p.id === item.prodId);
                        if (prod) totalVariableCost += (prod.totalCost * item.qty);
                    });
                });

                // 3. Fixed Costs (Prorated)
                // Calculate number of days in the selected period (or days since first order for 'all')
                let daysInPeriod = 30; // Default
                if (period === '7') daysInPeriod = 7;
                if (period === '30') daysInPeriod = 30;
                if (period === 'month') daysInPeriod = now.getDate();
                if (period === 'all') {
                    if (orders.length > 0) {
                        const firstOrderDate = new Date(Math.min(...orders.map(o => new Date(o.date))));
                        const diffTime = Math.abs(now - firstOrderDate);
                        daysInPeriod = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
                    } else {
                        daysInPeriod = 1;
                    }
                }

                const monthlyFixedTotal = fixedCostsItems.reduce((acc, i) => acc + i.cost, 0);
                const dailyFixedCost = monthlyFixedTotal / 30; // Approx
                const totalFixedCost = dailyFixedCost * daysInPeriod;

                // 4. Net Profit
                const totalCosts = totalVariableCost + totalFixedCost;
                const netProfit = totalRevenue - totalCosts;
                const marginPercent = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;

                // 5. KPI: Ticket Medio
                const avgTicket = filteredOrders.length > 0 ? (totalRevenue / filteredOrders.length) : 0;

                // --- RENDER CONTENT ---
                const html = `
                    <div class="kpi-grid">
                        <div class="card kpi-card">
                            <div class="kpi-icon"><i class="fas fa-coins"></i></div>
                            <div class="kpi-info">
                                <h3>${Utils.formatCurrency(totalRevenue)}</h3>
                                <p>Ingresos</p>
                            </div>
                        </div>
                        <div class="card kpi-card">
                            <div class="kpi-icon" style="color:var(--danger); background:rgba(255, 71, 87, 0.1);"><i class="fas fa-wallet"></i></div>
                            <div class="kpi-info">
                                <h3>${Utils.formatCurrency(totalCosts)}</h3>
                                <p>Costes Totales</p>
                            </div>
                        </div>
                        <div class="card kpi-card">
                            <div class="kpi-icon" style="color:var(--success); background:rgba(46, 213, 115, 0.1);"><i class="fas fa-chart-line"></i></div>
                            <div class="kpi-info">
                                <h3>${Utils.formatCurrency(netProfit)}</h3>
                                <p>Beneficio Neto</p>
                            </div>
                        </div>
                        <div class="card kpi-card">
                            <div class="kpi-icon" style="color:var(--primary); background:rgba(212, 175, 55, 0.1);"><i class="fas fa-percent"></i></div>
                            <div class="kpi-info">
                                <h3>${marginPercent}%</h3>
                                <p>Margen Real</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <h3 style="margin-bottom:20px;">Evolución Financiera</h3>
                            <div style="height: 300px; position: relative;">
                                <canvas id="chart-trend"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h3 style="margin-bottom:20px;">Desglose de Costes</h3>
                            <div style="height: 300px; position: relative;">
                                <canvas id="chart-composition"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top:20px;">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Cuenta de Resultados (P&L)</h3>
                        <div class="table-container">
                            <table style="max-width:600px; margin:0 auto;">
                                <tr>
                                    <td><strong>(+) Ventas Totales</strong></td>
                                    <td style="text-align:right; color:var(--success); font-weight:bold;">${Utils.formatCurrency(totalRevenue)}</td>
                                </tr>
                                <tr>
                                    <td>(-) Coste Productos (Materia Prima)</td>
                                    <td style="text-align:right; color:var(--danger);">${Utils.formatCurrency(totalVariableCost)}</td>
                                </tr>
                                <tr>
                                    <td>(-) Gastos Fijos (Estimado ${daysInPeriod} días)</td>
                                    <td style="text-align:right; color:var(--danger);">${Utils.formatCurrency(totalFixedCost)}</td>
                                </tr>
                                <tr style="border-top: 2px solid var(--dark); background:#f9f9f9;">
                                    <td style="font-size:1.2rem;"><strong>(=) BENEFICIO NETO</strong></td>
                                    <td style="text-align:right; font-size:1.2rem; font-weight:bold; color:${netProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${Utils.formatCurrency(netProfit)}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('dash-content').innerHTML = html;
                DashboardModule.renderCharts(filteredOrders, products, dailyFixedCost, startDate, period);
            },

            renderCharts: (orders, products, dailyFixedCost, startDate, period) => {
                // Destroy existing
                if (window.chartTrendInstance) window.chartTrendInstance.destroy();
                if (window.chartCompInstance) window.chartCompInstance.destroy();

                // --- CHART 1: TREND (Line) ---
                // Group data by day
                const daysMap = {};

                // Initialize days (for last 7/30 days to show empty days too)
                if (period === '7' || period === '30' || period === 'month') {
                    const d = new Date(startDate);
                    const now = new Date();
                    while (d <= now) {
                        const key = d.toLocaleDateString('es-ES');
                        daysMap[key] = { revenue: 0, cost: dailyFixedCost, profit: -dailyFixedCost };
                        d.setDate(d.getDate() + 1);
                    }
                }

                orders.forEach(o => {
                    const key = new Date(o.date).toLocaleDateString('es-ES');
                    if (!daysMap[key]) daysMap[key] = { revenue: 0, cost: dailyFixedCost, profit: -dailyFixedCost };

                    daysMap[key].revenue += o.total;

                    let orderCost = 0;
                    o.items.forEach(item => {
                        const prod = products.find(p => p.id === item.prodId);
                        if (prod) orderCost += (prod.totalCost * item.qty);
                    });

                    daysMap[key].cost += orderCost;
                    daysMap[key].profit = daysMap[key].revenue - daysMap[key].cost;
                });

                // Sort by date
                // Note: String date sorting might be tricky, better to rely on insertion order if initialized correctly, 
                // or parse back to date. For simplicity, we assume the initialization loop set the order correctly.
                // If 'all', we need to sort keys.
                let labels = Object.keys(daysMap);
                if (period === 'all') {
                    labels.sort((a, b) => {
                        const [da, ma, ya] = a.split('/');
                        const [db, mb, yb] = b.split('/');
                        return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
                    });
                }

                const dataRevenue = labels.map(l => daysMap[l].revenue);
                const dataCost = labels.map(l => daysMap[l].cost);
                const dataProfit = labels.map(l => daysMap[l].profit);

                window.chartTrendInstance = new Chart(document.getElementById('chart-trend'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Ingresos', data: dataRevenue, borderColor: '#D4AF37', tension: 0.3, fill: false },
                            { label: 'Costes', data: dataCost, borderColor: '#ff4757', tension: 0.3, fill: false },
                            { label: 'Beneficio', data: dataProfit, borderColor: '#2ed573', tension: 0.3, fill: true, backgroundColor: 'rgba(46, 213, 115, 0.1)' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // --- CHART 2: COMPOSITION (Doughnut) ---
                const totalRevenue = dataRevenue.reduce((a, b) => a + b, 0);
                const totalCostVar = orders.reduce((acc, o) => {
                    return acc + o.items.reduce((sum, item) => {
                        const prod = products.find(p => p.id === item.prodId);
                        return sum + (prod ? prod.totalCost * item.qty : 0);
                    }, 0);
                }, 0);

                // Recalculate fixed cost total for the chart based on the days shown
                const totalFixed = dailyFixedCost * labels.length;
                const totalProfit = totalRevenue - (totalCostVar + totalFixed);

                // Ensure no negative segments for doughnut (Chart.js doesn't like negative data)
                // We will show Profit as 0 if negative for the composition chart, or handle it differently.
                // Better: Show "Cost Structure" -> Variable vs Fixed vs Profit (if positive).

                const chartData = [totalCostVar, totalFixed];
                const chartLabels = ['Materia Prima', 'Gastos Fijos'];
                const chartColors = ['#ffa502', '#ff4757'];

                if (totalProfit > 0) {
                    chartData.push(totalProfit);
                    chartLabels.push('Beneficio Neto');
                    chartColors.push('#2ed573');
                }

                window.chartCompInstance = new Chart(document.getElementById('chart-composition'), {
                    type: 'doughnut',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: chartColors
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        };
        window.DashboardModule = DashboardModule;

        /* =========================================
           MODULE: INVENTORY
           ========================================= */
        const InventoryModule = {
            render: async () => {
                document.getElementById('page-title').innerText = 'Gestión de Stock y Gastos';
                const items = await DB.getAll('inventory');
                const ingredients = items.filter(i => i.type === 'ingredient');
                const fixedCosts = items.filter(i => i.type === 'fixed');

                let html = `
                    <div class="grid-2">
                        <div class="card">
                            <div class="flex-between" style="margin-bottom:15px;">
                                <h3><i class="fas fa-carrot"></i> Ingredientes</h3>
                                <button class="btn btn-primary" onclick="InventoryModule.openForm('ingredient')"><i class="fas fa-plus"></i> Añadir</button>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead><tr><th>Nombre</th><th>Precio/Ud</th><th>Stock</th><th>Acciones</th></tr></thead>
                                    <tbody>${InventoryModule.renderRows(ingredients)}</tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card">
                            <div class="flex-between" style="margin-bottom:15px;">
                                <h3><i class="fas fa-lightbulb"></i> Gastos Fijos</h3>
                                <button class="btn btn-primary" onclick="InventoryModule.openForm('fixed')"><i class="fas fa-plus"></i> Añadir</button>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead><tr><th>Concepto</th><th>Coste Mensual</th><th>Acciones</th></tr></thead>
                                    <tbody>${InventoryModule.renderRows(fixedCosts)}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                UI.render(html);
            },

            renderRows: (items) => {
                if (items.length === 0) return '<tr><td colspan="4" style="text-align:center; color:var(--gray);">Sin registros</td></tr>';
                return items.map(i => `
                    <tr>
                        <td><strong>${i.name}</strong><br><small style="color:var(--gray);">${i.unit || ''}</small></td>
                        <td>${Utils.formatCurrency(i.cost)}</td>
                        <td>${i.type === 'ingredient' ? (i.stock || 0) + ' ' + (i.unit || '') : '-'}</td>
                        <td>
                            <button class="btn-outline" onclick="InventoryModule.openForm('${i.type}', '${i.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-outline" style="color:var(--danger); border-color:var(--danger);" onclick="InventoryModule.delete('${i.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            openForm: async (type, id = null) => {
                let item = { name: '', type: type, unit: 'kg', cost: 0, stock: 0 };
                if (id) {
                    const items = await DB.getAll('inventory');
                    item = items.find(i => i.id === id);
                }

                const isIng = type === 'ingredient';
                const formHtml = `
                    <form onsubmit="event.preventDefault(); InventoryModule.save('${id || ''}', '${type}')">
                        <div class="form-group">
                            <label class="form-label">Nombre *</label>
                            <input type="text" id="inv-name" class="form-control" value="${item.name}" required>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">${isIng ? 'Precio por Unidad (€)' : 'Coste Mensual (€)'} *</label>
                                <input type="number" step="0.01" id="inv-cost" class="form-control" value="${item.cost}" required>
                            </div>
                            ${isIng ? `
                            <div class="form-group">
                                <label class="form-label">Unidad (ej. kg, L, ud)</label>
                                <input type="text" id="inv-unit" class="form-control" value="${item.unit}">
                            </div>
                            ` : ''}
                        </div>
                        ${isIng ? `
                        <div class="form-group">
                            <label class="form-label">Stock Actual</label>
                            <input type="number" step="0.01" id="inv-stock" class="form-control" value="${item.stock}">
                        </div>
                        ` : ''}
                        <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px;">Guardar</button>
                    </form>
                `;
                UI.openModal(id ? 'Editar Item' : (isIng ? 'Nuevo Ingrediente' : 'Nuevo Gasto Fijo'), formHtml);
            },

            save: async (id, type) => {
                const item = {
                    id: id || Utils.generateId(),
                    type: type,
                    name: document.getElementById('inv-name').value,
                    cost: parseFloat(document.getElementById('inv-cost').value) || 0,
                    unit: type === 'ingredient' ? document.getElementById('inv-unit').value : null,
                    stock: type === 'ingredient' ? (parseFloat(document.getElementById('inv-stock').value) || 0) : null,
                    updated: new Date().toISOString()
                };

                await DB.add('inventory', item);
                UI.closeModal();
                UI.showToast('Guardado correctamente', 'success');
                InventoryModule.render();
            },

            delete: async (id) => {
                if (confirm('¿Eliminar este elemento?')) {
                    await DB.delete('inventory', id);
                    UI.showToast('Eliminado', 'success');
                    InventoryModule.render();
                }
            }
        };
        window.InventoryModule = InventoryModule;

        /* =========================================
           MODULE: CONFIG
           ========================================= */
        const ConfigModule = {
            render: () => {
                document.getElementById('page-title').innerText = 'Configuración';
                let html = `
                    <div class="card">
                        <h3><i class="fas fa-database"></i> Gestión de Datos</h3>
                        <p style="color:var(--gray); margin-bottom:20px;">Exporta una copia de seguridad o restaura datos desde un archivo JSON.</p>
                        
                        <div class="grid-2">
                            <div style="padding:20px; background:#f9f9f9; border-radius:8px; text-align:center;">
                                <i class="fas fa-download" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                                <h4>Exportar Datos</h4>
                                <p style="font-size:0.9rem; margin-bottom:15px;">Descarga todo (Clientes, Productos, Pedidos)</p>
                                <button class="btn btn-primary" onclick="ConfigModule.exportData()">Descargar JSON</button>
                            </div>

                            <div style="padding:20px; background:#f9f9f9; border-radius:8px; text-align:center;">
                                <i class="fas fa-upload" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                                <h4>Importar Datos</h4>
                                <p style="font-size:0.9rem; margin-bottom:15px;">Restaura una copia de seguridad</p>
                                <input type="file" id="import-file" accept=".json" style="display:none;" onchange="ConfigModule.importData(this)">
                                <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">Seleccionar Archivo</button>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="border-left: 5px solid var(--danger);">
                        <h3 style="color:var(--danger);"><i class="fas fa-exclamation-triangle"></i> Zona de Peligro</h3>
                        <p style="margin-bottom:20px;">Estas acciones son destructivas y no se pueden deshacer.</p>
                        <button class="btn btn-danger" onclick="ConfigModule.resetSystem()">Borrar Todo y Reiniciar</button>
                    </div>

                    <div style="margin-top:30px; text-align:left;">
                        <a href="#" onclick="event.preventDefault(); ConfigModule.showVersion();" style="color:var(--gray); font-size:0.9rem; text-decoration:none;">
                            <i class="fas fa-code-branch"></i> Versión 1.0
                        </a>
                    </div>
                `;
                UI.render(html);
            },

            showVersion: () => {
                const versionInfo = `
                    <div style="text-align:left;">
                        <h2 style="margin-bottom:15px;"><i class="fas fa-rocket"></i> El Zorro - Gestión Integral</h2>
                        <p style="font-size:1.2rem; margin-bottom:20px;"><strong>Versión 1.0</strong></p>
                        
                        <hr style="border:none; border-top:1px solid var(--border); margin:15px 0;">
                        
                        <h4 style="margin-bottom:10px;"><i class="fas fa-star"></i> Funcionalidades</h4>
                        <ul style="line-height:1.8; padding-left:20px; margin-bottom:20px;">
                            <li><strong>Dashboard Avanzado:</strong> KPIs en tiempo real, gráficos de tendencias financieras (Ingresos/Costes/Beneficio), desglose de costes (Materia Prima vs Gastos Fijos), y filtros por periodo.</li>
                            <li><strong>Gestión de Clientes:</strong> Alta, edición y borrado de clientes con teléfono y notas.</li>
                            <li><strong>Gestión de Productos:</strong> Catálogo con precio de venta y cálculo automático de costes variables (ingredientes).</li>
                            <li><strong>Gestión de Pedidos:</strong> Creación de pedidos con múltiples productos, seguimiento de estado y control de pagos.</li>
                            <li><strong>Stock e Inventario:</strong> Alta de ingredientes con precio por unidad (kg, L, ud) y gastos fijos mensuales (Luz, Alquiler).</li>
                            <li><strong>Conversión de Unidades:</strong> Al añadir costes de ingredientes, permite seleccionar unidades de consumo (g, ml) y calcula el coste automáticamente desde la unidad de stock (kg, L).</li>
                            <li><strong>Cuenta de Resultados (P&L):</strong> Vista simplificada de Ventas - Costes = Beneficio Neto.</li>
                            <li><strong>Backup & Restore:</strong> Exporta e importa todos los datos en formato JSON.</li>
                        </ul>

                        <h4 style="margin-bottom:10px;"><i class="fas fa-database"></i> Almacenamiento</h4>
                        <p style="margin-bottom:20px;">Todos los datos se guardan localmente en tu navegador usando <strong>IndexedDB</strong>. No se envían datos a ningún servidor.</p>

                        <p style="font-size:0.85rem; color:var(--gray);">Desarrollado por Claude</p>
                    </div>
                `;
                UI.openModal('Acerca de', versionInfo);
            },

            exportData: async () => {
                const data = {
                    clients: await DB.getAll('clients'),
                    products: await DB.getAll('products'),
                    orders: await DB.getAll('orders'),
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_elzorro_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                UI.showToast('Copia de seguridad descargada', 'success');
            },

            importData: (input) => {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.clients || !data.products || !data.orders) throw new Error('Formato inválido');

                        if (confirm(`Se importarán:\n- ${data.clients.length} Clientes\n- ${data.products.length} Productos\n- ${data.orders.length} Pedidos\n\n¿Continuar? (Se sobrescribirán los datos actuales)`)) {
                            await DB.clearAll();

                            for (const c of data.clients) await DB.add('clients', c);
                            for (const p of data.products) await DB.add('products', p);
                            for (const o of data.orders) await DB.add('orders', o);

                            UI.showToast('Datos importados correctamente', 'success');
                            setTimeout(() => location.reload(), 1000);
                        }
                    } catch (err) {
                        console.error(err);
                        UI.showToast('Error al importar: Archivo corrupto o inválido', 'error');
                    }
                };
                reader.readAsText(file);
                input.value = ''; // Reset input
            },

            resetSystem: async () => {
                if (confirm('¿ESTÁS SEGURO? Se borrarán TODOS los datos permanentemente.')) {
                    if (confirm('Esta acción es IRREVERSIBLE. ¿Confirmar borrado total?')) {
                        await DB.clearAll();
                        UI.showToast('Sistema reiniciado', 'success');
                        setTimeout(() => location.reload(), 1000);
                    }
                }
            }
        };
        window.ConfigModule = ConfigModule;

        /* =========================================
           MAIN APP LOGIC
           ========================================= */
        const App = {
            init: async () => {
                await DB.init();
                await DB.seedDefaults();
                App.setupNav();
                // Load default view
                DashboardModule.render();
            },

            setupNav: () => {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        const view = e.currentTarget.dataset.view;

                        // Routing
                        if (view === 'dashboard') DashboardModule.render();
                        if (view === 'clients') ClientsModule.render();
                        if (view === 'products') ProductsModule.render();
                        if (view === 'orders') OrdersModule.render();
                        if (view === 'inventory') InventoryModule.render();
                        if (view === 'config') ConfigModule.render();

                        // Mobile menu close
                        if (window.innerWidth < 768) document.getElementById('sidebar').classList.remove('active');
                    });
                });

                document.getElementById('menu-toggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('active');
                });
            }
        };

        // Start App
        App.init();

    </script>
</body>

</html>